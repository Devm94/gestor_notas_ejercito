{% load static %}

<nav class="main-header navbar navbar-expand navbar-white navbar-light">
  <ul class="navbar-nav">
    <li class="nav-item">
      <a class="nav-link" data-widget="pushmenu" href="#" role="button"
        ><i class="fas fa-bars"></i
      ></a>
    </li>
  </ul>
  <ul class="navbar-nav ml-auto">
    <li class="nav-item dropdown">
      <a class="nav-link" data-toggle="dropdown" href="#" aria-expanded="false">
        <i class="far fa-bell"></i>
        <span class="badge badge-warning navbar-badge" id="noti-count"
          >{{noti_count}}</span
        >
      </a>
      <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
        <span class="dropdown-header" id="noti-header">Notificaciones</span>
        <div class="dropdown-divider"></div>
        <div id="noti-list">
          {% if notificaciones %} {% for n in notificaciones %}
          <a href="{{ n.link }}" class="dropdown-item"> {{ n.cod_nota.cod_procedencia }} - {{ n.fch_limite_formateada }} </a>
          {% endfor %} {% else %}
          <a href="#" class="dropdown-item">No hay notificaciones</a>
          {% endif %}
        </div>
        <div class="dropdown-divider"></div>
        
          href="{% url 'aprobacion' %}"
          class="dropdown-item dropdown-footer"
          >Ver todas</a
        >
      </div>
    </li>

    <li class="nav-item">
      <span class="nav-link">
        {{usuario}}
      </span>
    </li>
  </ul>
</nav>
<aside class="main-sidebar sidebar-dark-primary elevation-4">
  <div class="sidebar">
    <div class="user-panel mt-3 pb-3 mb-3 d-flex">
      <div class="image">
        <img
          src="{% static 'img/ejercito.png' %}"
          class="elevation-2"
          alt="User Image"
        />
      </div>
      <div class="info">
        <a href="{% url 'inicio_2' %}" class="d-block">Gestor de Notas</a>
      </div>
    </div>
    <nav class="mt-2">
      <ul
        class="nav nav-pills nav-sidebar flex-column"
        data-widget="treeview"
        role="menu"
        data-accordion="false"
      >
        {% if perms.documentos.recepcion %}
        <li class="nav-item">
          <a href="{% url 'recepcion' %}" class="nav-link">
            <i class="nav-icon fas fa-landmark"></i>
            <p>Recepcion</p>
          </a>
        </li>
        {% endif %} {% if perms.documentos.procesar %}
        <li class="nav-item">
          <a href="{% url 'procesamiento' %}" class="nav-link">
            <i class="nav-icon fas fa-file-alt"></i>
            <p>Procesamiento</p>
          </a>
        </li>
        {% endif %} {% if perms.documentos.aprobar %}

        <li class="nav-item">
          <a href="{% url 'aprobacion' %}" class="nav-link">
            <i class="nav-icon fas fa-book"></i>
            <p>Aprobacion</p>
          </a>
        </li>
        {% endif %} {% if perms.documentos.bandeja %}

        <li class="nav-item">
          <a href="{% url 'bandeja' %}" class="nav-link">
            <i class="nav-icon fas fa-inbox"></i>
            <p>Bandeja</p>
          </a>
        </li>
        {% endif %}
        <li class="nav-item">
          <a href="{% url 'notas_enviadas' %}" class="nav-link">
            <i class="nav-icon fas fa-paper-plane"></i>
            <p>Notas Enviadas</p>
          </a>
        </li>
        <li class="nav-item">
          <a href="{% url 'calendario' %}" class="nav-link">
            <i class="nav-icon fas fa-calendar"></i>
            <p>Calendario</p>
          </a>
        </li>
        <li class="nav-item">
          <a href="{% url 'reporte_mensual' %}" class="nav-link">
            <i class="nav-icon fas fa-calendar"></i>
            <p>Reporte</p>
          </a>
        </li>
        {% if perms.documentos.crear_procedencia %}
<li class="nav-item has-treeview">
  <a href="#" class="nav-link">
    <i class="nav-icon fas fa-cog"></i>
    <p>
      Mantenimiento
      <i class="right fas fa-angle-left"></i>
    </p>
  </a>
  <ul class="nav nav-treeview">
    <li class="nav-item">
      <a href="{% url 'firma_autorizada' %}" class="nav-link">
        <i class="far fa-circle nav-icon"></i>
        <p>Firma Aut.</p>
      </a>
    </li>
    <li class="nav-item">
      <a href="{% url 'manto_sistema' %}" class="nav-link">
        <i class="far fa-circle nav-icon"></i>
        <p>Procedencia</p>
      </a>
    </li>
  </ul>
</li>
        {% endif %}

        <!-- Nueva opción: Cambiar Contraseña -->
        <li class="nav-item">
          <a href="#" class="nav-link" data-toggle="modal" data-target="#cambiarContrasenaModal">
            <i class="nav-icon fas fa-key"></i>
            <p>Cambiar Contraseña</p>
          </a>
        </li>

        <li class="nav-item mt-auto">
          <form
            action="{% url 'cerrar_sesion' %}"
            method="post"
            class="nav-link p-0 m-0"
          >
            {% csrf_token %}
            <button
              type="submit"
              class="btn btn-block text-left text-white"
              style="background: none; border: none"
            >
              <i class="nav-icon fas fa-sign-out-alt"></i>
              <p>Cerrar sesión</p>
            </button>
          </form>
        </li>
      </ul>
    </nav>
  </div>
</aside>

<!-- Modal Cambiar Contraseña -->
<div class="modal fade" id="cambiarContrasenaModal" tabindex="-1" role="dialog" aria-labelledby="cambiarContrasenaModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary">
        <h5 class="modal-title" id="cambiarContrasenaModalLabel">
          <i class="fas fa-key"></i> Cambiar Contraseña
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="formCambiarContrasena">
        {% csrf_token %}
        <div class="modal-body">
          <div class="form-group">
            <label for="old_password">Contraseña Actual</label>
            <input type="password" class="form-control" id="old_password" name="old_password" required>
          </div>
          <div class="form-group">
            <label for="new_password1">Nueva Contraseña</label>
            <input type="password" class="form-control" id="new_password1" name="new_password1" required>
            <small class="form-text text-muted">
              Mínimo 8 caracteres. No puede ser muy similar a tu información personal.
            </small>
          </div>
          <div class="form-group">
            <label for="new_password2">Confirmar Nueva Contraseña</label>
            <input type="password" class="form-control" id="new_password2" name="new_password2" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnGuardarPassword">
            <i class="fas fa-save"></i> Guardar Cambios
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Asegúrate de tener SweetAlert2 incluido -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  
  // Usar onclick en el botón en lugar de submit en el formulario
  document.getElementById('btnGuardarPassword').addEventListener('click', function() {
    var form = document.getElementById('formCambiarContrasena');
    var formData = new FormData(form);
    
    // Deshabilitar botón mientras procesa
    this.disabled = true;
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
    var btn = this;
    
    // Hacer la petición AJAX
    fetch("{% url 'cambiar_contrasena' %}", {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
      
      if(data.success) {
        // Cerrar modal
        $('#cambiarContrasenaModal').modal('hide');
        // Limpiar formulario
        form.reset();
        
        // Mostrar alerta de éxito
        Swal.fire({
          icon: 'success',
          title: '¡Éxito!',
          text: 'Contraseña actualizada exitosamente',
          confirmButtonText: 'Aceptar',
          confirmButtonColor: '#007bff'
        });
        
      } else {
        // Mostrar errores
        var errorMsg = data.errors.join('\n');
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: errorMsg,
          confirmButtonText: 'Aceptar',
          confirmButtonColor: '#dc3545'
        });
      }
    })
    .catch(error => {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
      
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Ocurrió un error al procesar la solicitud',
        confirmButtonText: 'Aceptar',
        confirmButtonColor: '#dc3545'
      });
    });
  });
  
  // Limpiar formulario al cerrar modal
  $('#cambiarContrasenaModal').on('hidden.bs.modal', function () {
    document.getElementById('formCambiarContrasena').reset();
  });
});
</script>